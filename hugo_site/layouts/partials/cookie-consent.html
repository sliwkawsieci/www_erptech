{{ $isPL := eq .Site.Language.Lang "pl" }}
{{ $cookieTitle := cond $isPL "Zgoda na cookies" "Cookie consent" }}
{{ $cookieDesc := cond $isPL "Używamy opcjonalnych cookies analitycznych (Matomo, Google Analytics 4), aby mierzyć ruch i ulepszać serwis. Są one ładowane dopiero po Twojej zgodzie." "We use optional analytics cookies (Matomo, Google Analytics 4) to measure traffic and improve the site. They load only after you grant consent." }}
{{ $acceptLabel := cond $isPL "Akceptuj wszystkie" "Accept all" }}
{{ $declineLabel := cond $isPL "Tylko niezbędne" "Necessary only" }}
{{ $settingsLabel := cond $isPL "Ustawienia" "Settings" }}
{{ $analyticsLabel := cond $isPL "Cookies analityczne" "Analytics cookies" }}
{{ $saveLabel := cond $isPL "Zapisz ustawienia" "Save settings" }}
{{ $manageLabel := cond $isPL "Zarządzaj preferencjami" "Manage preferences" }}

<div id="cookie-consent-banner" class="fixed inset-x-4 bottom-4 z-50 max-w-3xl mx-auto rounded-2xl bg-white shadow-2xl border border-gray-200 p-6 space-y-4 hidden">
    <div class="flex items-start gap-4">
        <div class="flex-shrink-0 w-12 h-12 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </div>
        <div>
            <p class="text-lg font-semibold text-gray-900">{{ $cookieTitle }}</p>
            <p class="text-sm text-gray-600 mt-1">{{ $cookieDesc }}</p>
            <button id="cookie-open-preferences" class="mt-3 text-sm font-medium text-orange-600 hover:text-orange-700 underline decoration-dotted">
                {{ $manageLabel }}
            </button>
        </div>
    </div>
    <div class="flex flex-col sm:flex-row sm:items-center gap-3">
        <button id="cookie-accept-all" class="w-full sm:w-auto inline-flex justify-center px-5 py-2.5 rounded-xl bg-orange-500 hover:bg-orange-600 text-white font-semibold transition">
            {{ $acceptLabel }}
        </button>
        <button id="cookie-decline" class="w-full sm:w-auto inline-flex justify-center px-5 py-2.5 rounded-xl border border-gray-300 text-gray-800 font-semibold hover:bg-gray-50 transition">
            {{ $declineLabel }}
        </button>
    </div>
    <div id="cookie-preferences" class="hidden border-t border-gray-200 pt-4 mt-2">
        <p class="text-sm font-semibold text-gray-900 mb-4">{{ $settingsLabel }}</p>
        <label class="flex items-start gap-3">
            <input type="checkbox" id="cookie-analytics-toggle" class="mt-1 w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
            <span>
                <strong class="block text-gray-900">{{ $analyticsLabel }}</strong>
                <span class="text-sm text-gray-600">{{ $cookieDesc }}</span>
            </span>
        </label>
        <button id="cookie-save-settings" class="mt-4 inline-flex items-center justify-center px-4 py-2 rounded-lg bg-gray-900 text-white text-sm font-semibold hover:bg-black transition">
            {{ $saveLabel }}
        </button>
    </div>
</div>

<script>
(function () {
    const storageKey = 'erptech-cookie-consent';
    const banner = document.getElementById('cookie-consent-banner');
    const analyticsToggle = document.getElementById('cookie-analytics-toggle');
    const openPreferencesBtn = document.getElementById('cookie-open-preferences');
    const preferencesPanel = document.getElementById('cookie-preferences');
    const acceptBtn = document.getElementById('cookie-accept-all');
    const declineBtn = document.getElementById('cookie-decline');
    const saveSettingsBtn = document.getElementById('cookie-save-settings');

    const analyticsConfig = {
        gaId: 'G-S3Y6QBN3F3',
        matomoUrl: 'https://www.vh13224.vh.net.pl/',
        matomoSiteId: '1'
    };

    function getStoredConsent() {
        try {
            const raw = localStorage.getItem(storageKey);
            if (raw) {
                return JSON.parse(raw);
            }
        } catch (err) {
            console.warn('Cookie consent parse error', err);
        }
        return { analytics: null };
    }

    function storeConsent(state) {
        localStorage.setItem(storageKey, JSON.stringify(state));
    }

    function showBanner() {
        if (banner) {
            banner.classList.remove('hidden');
        }
    }

    function hideBanner() {
        if (banner) {
            banner.classList.add('hidden');
            preferencesPanel.classList.add('hidden');
        }
    }

    function loadGoogleAnalytics() {
        if (window.gtag) {
            return;
        }
        window.dataLayer = window.dataLayer || [];
        window.gtag = function () { dataLayer.push(arguments); };
        window.gtag('js', new Date());
        window.gtag('config', analyticsConfig.gaId, { 'anonymize_ip': true });

        const script = document.createElement('script');
        script.async = true;
        script.src = 'https://www.googletagmanager.com/gtag/js?id=' + analyticsConfig.gaId;
        document.head.appendChild(script);
    }

    function loadMatomo() {
        if (window._matomoScriptLoaded) {
            return;
        }
        window._matomoScriptLoaded = true;
        window._paq = window._paq || [];
        window._paq.push(['setDocumentTitle', document.title]);
        window._paq.push(['setDomains', ['*.erptech.pl']]);
        window._paq.push(['enableLinkTracking']);
        window._paq.push(['trackPageView']);
        window._paq.push(['setSiteId', analyticsConfig.matomoSiteId]);
        window._paq.push(['setTrackerUrl', analyticsConfig.matomoUrl + 'matomo.php']);

        const script = document.createElement('script');
        script.async = true;
        script.src = analyticsConfig.matomoUrl + 'matomo.js';
        document.head.appendChild(script);
    }

    function applyConsent(state) {
        if (state.analytics) {
            loadGoogleAnalytics();
            loadMatomo();
        } else {
            window['ga-disable-' + analyticsConfig.gaId] = true;
            if (window._paq) {
                window._paq.push(['forgetUserOptOut']);
            }
        }
    }

    function openPreferences() {
        preferencesPanel.classList.remove('hidden');
    }

    if (openPreferencesBtn) {
        openPreferencesBtn.addEventListener('click', () => {
            openPreferences();
        });
    }

    if (acceptBtn) {
        acceptBtn.addEventListener('click', () => {
            const newState = { analytics: true, timestamp: Date.now() };
            analyticsToggle.checked = true;
            storeConsent(newState);
            applyConsent(newState);
            hideBanner();
        });
    }

    if (declineBtn) {
        declineBtn.addEventListener('click', () => {
            analyticsToggle.checked = false;
            const newState = { analytics: false, timestamp: Date.now() };
            storeConsent(newState);
            applyConsent(newState);
            hideBanner();
        });
    }

    if (saveSettingsBtn) {
        saveSettingsBtn.addEventListener('click', () => {
            const newState = { analytics: !!analyticsToggle.checked, timestamp: Date.now() };
            storeConsent(newState);
            applyConsent(newState);
            hideBanner();
        });
    }

    const consent = getStoredConsent();
    if (consent.analytics === null) {
        showBanner();
    } else {
        analyticsToggle.checked = !!consent.analytics;
        applyConsent(consent);
    }

    window.ERPTechCookieConsent = {
        open: () => {
            analyticsToggle.checked = getStoredConsent().analytics === true;
            showBanner();
        },
        state: () => getStoredConsent()
    };
})();
</script>
